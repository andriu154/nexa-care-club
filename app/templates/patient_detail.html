{% extends "base.html" %}

{% block title %}
  {{ patient.full_name }} <span class="muted">• Paciente #{{ patient.id }}</span>
{% endblock %}

{% block actions %}
  <a class="btn btn-ghost" href="/app/patients">Volver</a>
  <a class="btn btn-ghost" href="{{ pdf_consolidated_url }}" target="_blank">PDF consolidado</a>
  <form method="post" action="/app/patients/{{ patient.id }}/new-encounter" style="display:inline;">
    <button class="btn btn-primary" type="submit">+ Nueva atención</button>
  </form>
{% endblock %}

{% block content %}
  <div class="grid">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="h2">Timeline clínico</div>
          <div class="muted">Cada atención mantiene su médico, fecha, firma y sello en PDF.</div>
        </div>
        <div class="stats">
          <div class="stat">
            <div class="stat-label">Estado</div>
            <div class="stat-value">{{ patient.status }}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Sesiones</div>
            <div class="stat-value">{{ patient.completed_sessions }}/{{ patient.total_sessions }}</div>
          </div>
        </div>
      </div>

      <div class="timeline">
        {% if items|length == 0 %}
          <div class="empty">
            <div class="empty-title">Sin atenciones</div>
            <div class="muted">Crea la primera atención con “Nueva atención”.</div>
          </div>
        {% endif %}

        {% for it in items %}
          {% set enc = it.enc %}
          {% set doc = it.doc %}
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-card">
              <div class="row">
                <div>
                  <div class="strong">
                    {{ (enc.ended_at or enc.created_at).strftime("%Y-%m-%d %H:%M") if (enc.ended_at or enc.created_at) else "—" }}
                    <span class="muted">• Atención #{{ enc.id }}</span>
                  </div>
                  <div class="muted">
                    {{ doc.name if doc else ("Doctor ID " ~ enc.doctor_id) }}
                    {% if doc and doc.specialty %} • {{ doc.specialty }}{% endif %}
                    {% if doc and doc.registration %} • Reg. {{ doc.registration }}{% endif %}
                  </div>
                </div>

                <div class="actions">
                  {% if enc.ended_at %}
                    <span class="badge badge-locked">Cerrada</span>
                  {% else %}
                    <span class="badge badge-open">Abierta</span>
                  {% endif %}
                  <a class="btn btn-ghost" href="/app/encounters/{{ enc.id }}">Ver</a>
                  <a class="btn btn-ghost" href="{{ it.pdf_url }}" target="_blank">PDF</a>
                </div>
              </div>

              <div class="summary">
                <div class="chip">{{ enc.visit_type or "Ambulatorio" }}</div>
                <div class="muted">{{ enc.chief_complaint_short or "—" }}</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="h2">Acciones rápidas</div>
          <div class="muted">Todo lo que necesitas para trabajar rápido.</div>
        </div>
      </div>
      <div class="card-body">
        <a class="btn btn-primary w100" href="{{ pdf_consolidated_url }}" target="_blank">Descargar PDF consolidado</a>
        <div style="height:10px"></div>
        <a class="btn btn-ghost w100" href="/docs" target="_blank">Abrir API /docs</a>
      </div>
    </div>
  </div>
{% endblock %}
