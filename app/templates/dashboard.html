{% extends "base.html" %}

{% block title %}
  Agenda • {{ base_date }}
{% endblock %}

{% block actions %}
  <a class="btn btn-ghost" href="/app/appointments/new?date={{ base_date }}">+ Nueva cita</a>
{% endblock %}

{% block content %}
  <div class="card">
    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
      <div>
        <h3 style="margin:0;">Ventana de agenda</h3>
        <div class="muted" style="margin-top:6px;">
          Ayer ({{ start_date }}) → Próximos 7 días ({{ end_date }})
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <a class="btn btn-ghost" href="/app?date={{ prev_date }}">◀ Día anterior</a>
        <a class="btn btn-ghost" href="/app">Hoy</a>
        <a class="btn btn-ghost" href="/app?date={{ next_date }}">Día siguiente ▶</a>

        <form method="get" action="/app" style="display:flex; gap:8px; align-items:center;">
          <input class="input" type="date" name="date" value="{{ base_date }}" style="min-width:170px;">
          <button class="btn btn-primary" type="submit">Ir</button>
        </form>
      </div>
    </div>
  </div>

  {% for day in ordered_days %}
    <div class="card" style="margin-top:14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <h3 style="margin:0;">{{ day }}</h3>
        <a class="btn btn-ghost" href="/app/appointments/new?date={{ day }}">Agendar</a>
      </div>

      {% if day not in days or (days[day] | length) == 0 %}
        <div class="muted" style="margin-top:10px;">Sin citas.</div>
      {% else %}
        <div class="list" style="margin-top:10px;">
          {% for a in days[day] %}
            <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.06);">
              <div style="min-width:120px;">
                <strong>{{ a.start_at.strftime("%H:%M") }}</strong>
                <span class="muted">– {{ a.end_at.strftime("%H:%M") }}</span>
              </div>

              <div style="flex:1;">
                <div><strong>{{ a.patient.full_name }}</strong></div>
                <div class="muted" style="margin-top:2px;">
                  {{ a.reason if a.reason else "—" }}
                </div>
              </div>

              <div class="muted" style="min-width:110px; text-align:right;">
                {{ a.status }}
              </div>

              <div style="display:flex; gap:8px; align-items:center;">
                <form method="post" action="/app/appointments/{{ a.id }}/cancel?date={{ base_date }}" style="display:inline;">
                  <button class="btn btn-ghost" type="submit">Cancelar</button>
                </form>

                <details>
                  <summary class="btn btn-ghost" style="cursor:pointer;">Reagendar</summary>
                  <form method="post" action="/app/appointments/{{ a.id }}/reschedule" style="margin-top:10px;">
                    <input class="input" type="hidden" name="date" value="{{ day }}">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <input class="input" type="time" name="time" value="{{ a.start_at.strftime('%H:%M') }}" required>
                      <input class="input" type="number" name="duration_min" value="{{ ((a.end_at - a.start_at).seconds // 60) }}" min="10" max="240" required>
                      <button class="btn btn-primary" type="submit">Guardar</button>
                    </div>
                  </form>
                </details>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  {% endfor %}
{% endblock %}
